{% extends 'layouts/layout.html' %}
{% load dict_filter %}
{% block content %}

<style>
/* =========================
   SCROLL CONTAINER
========================= */
.table-responsive {
    max-height: 75vh;
    overflow: auto;
}

/* =========================
   TABLE SIZE
========================= */
table.table-sm td,
table.table-sm th {
    padding: 4px !important;
    font-size: 13px;
}

.col-tanggal {
    min-width: 100px;
    white-space: nowrap;
}

/* =========================
   HEADER TANGGAL (KECUALI KOLOM NAMA)
========================= */
.table thead th:not(.sticky-col-header) {
    position: sticky;
    top: 0;
    background: #6c757d;
    color: white;
    z-index: 10;
}

/* =========================
   KOLOM NAMA (BODY)
========================= */
.sticky-col {
    position: sticky;
    left: 0;
    background: white;
    z-index: 5;
}

/* =========================
   HEADER NAMA (POJOK KIRI ATAS)
========================= */
.sticky-col-header {
    position: sticky;
    top: 0;
    left: 0;
    background: #6c757d;
    color: white;
    z-index: 30; /* MUTLAK PALING ATAS */
}

/* =========================
   SELECT SIZE
========================= */
select.form-control-sm {
    padding: 1px 4px !important;
    height: 28px;
}
</style>

<div class="card">
    <div class="card-header bg-warning">
        <h3 class="card-title text-white">
            Edit Jadwal Karyawan - {{ bulan_text }} {{ tahun }}
        </h3>
    </div>

    <form method="POST" action="{% url 'update_jadwal' %}">
        {% csrf_token %}
        <input type="hidden" name="bulan" value="{{ bulan }}">
        <input type="hidden" name="tahun" value="{{ tahun }}">

        <div class="card-body table-responsive p-0">
            <table class="table table-bordered table-sm text-center">
                <thead class="bg-secondary text-white">
                    <tr>
                        <th class="sticky-col-header" style="min-width: 180px;">Nama Karyawan</th>
                        {% for tgl in tanggal_list %}
                            <th class="col-tanggal">{{ tgl }}</th>
                        {% endfor %}
                    </tr>
                </thead>

                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="sticky-col text-left font-weight-bold">
                            {{ user.name }}
                        </td>

                        {% for tgl in tanggal_list %}
                        <td class="col-tanggal">

                            {% with data_hari=jadwal_lama|dict_get:user.nik|dict_get:tgl %}

                            <select class="form-control form-control-sm mb-1"
                                    name="shift_{{ user.nik }}_{{ tgl }}_1"
                                    {% if data_hari|dict_get:1 == "CUTI" or data_hari|dict_get:1 == "IZIN" %}
                                        disabled
                                    {% endif %}
                            >

                                <option value="-" {% if not data_hari %}selected{% endif %}>-</option>

                                {% for schedule in schedules %}
                                    {% with selected_value=data_hari|dict_get:1 %}

                                        {% if selected_value == "CUTI" or selected_value == "IZIN" %}
                                            {% if schedule.id == selected_value %}
                                                <option value="{{ schedule.id }}" selected>
                                                    {{ schedule.name }}
                                                </option>
                                            {% endif %}
                                        {% else %}
                                            {% if schedule.id != "CUTI" and schedule.id != "IZIN" %}
                                                <option value="{{ schedule.id }}"
                                                    {% if selected_value == schedule.id %}selected{% endif %}
                                                >
                                                    {{ schedule.name }}
                                                </option>
                                            {% endif %}
                                        {% endif %}

                                    {% endwith %}
                                {% endfor %}
                            </select>

                            <select class="form-control form-control-sm"
                                    name="shift_{{ user.nik }}_{{ tgl }}_2"
                                    {% if data_hari|dict_get:2 == "CUTI" or data_hari|dict_get:2 == "IZIN" %}
                                        disabled
                                    {% endif %}
                            >

                                <option value="-" {% if not data_hari %}selected{% endif %}>-</option>

                                {% for schedule in schedules %}
                                    {% with selected_value=data_hari|dict_get:2 %}

                                        {% if selected_value == "CUTI" or selected_value == "IZIN" %}
                                            {% if schedule.id == selected_value %}
                                                <option value="{{ schedule.id }}" selected>
                                                    {{ schedule.name }}
                                                </option>
                                            {% endif %}
                                        {% else %}
                                            {% if schedule.id != "CUTI" and schedule.id != "IZIN" %}
                                                <option value="{{ schedule.id }}"
                                                    {% if selected_value == schedule.id %}selected{% endif %}
                                                >
                                                    {{ schedule.name }}
                                                </option>
                                            {% endif %}
                                        {% endif %}

                                    {% endwith %}
                                {% endfor %}
                            </select>

                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-footer text-right">
            <button type="submit" class="btn btn-success">
                <i class="fa fa-save"></i> Simpan Perubahan
            </button>
        </div>
    </form>
</div>

{% endblock %}