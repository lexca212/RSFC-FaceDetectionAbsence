{% extends 'layouts/layout.html' %}
{% load dict_filter %}
{% block content %}

<style>
    /* Kolom pertama (Nama Karyawan) tetap saat scroll */
    .sticky-col {
        position: sticky;
        left: 0;
        background: white;
        z-index: 10;
    }

    /* Header kolom pertama */
    .sticky-col-header {
        position: sticky;
        left: 0;
        background: #6c757d; /* sama seperti header abu-abu */
        color: white;
        z-index: 11;
    } 

    table.table-sm td,
    table.table-sm th {
        padding: 4px !important;
        font-size: 13px;
    }

    select.form-control-sm {
        padding: 1px 4px !important;
        height: 28px;
    }

    .table-responsive {
        max-height: 75vh;
        overflow-x: auto;
        overflow-y: auto;
    }
    .col-tanggal {
        min-width: 100px;
        white-space: nowrap;
    }

    .table-responsive {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 75vh;
    }
</style>

<div class="card">
    <div class="card-header bg-warning">
        <h3 class="card-title text-white">
            Edit Jadwal Karyawan - {{ bulan_text }} {{ tahun }}
        </h3>
    </div>

    <form method="POST" action="{% url 'update_jadwal' %}">
        {% csrf_token %}
        <input type="hidden" name="bulan" value="{{ bulan }}">
        <input type="hidden" name="tahun" value="{{ tahun }}">
        {% comment %} <input type="hidden" name="divisi" value="{{ divisi }}"> {% endcomment %}

        <div class="card-body table-responsive p-0">
            <table class="table table-bordered table-sm text-center">
                <thead class="bg-secondary text-white">
                    <tr>
                        <th class="sticky-col-header" style="min-width: 180px;">Nama Karyawan</th>

                        {% for tgl in tanggal_list %}
                            <th class="col-tanggal">{{ tgl }}</th>
                        {% endfor %}
                    </tr>
                </thead>

                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="sticky-col text-left font-weight-bold">{{ user.name }}</td>

                        {% for tgl in tanggal_list %}
                        <td class="col-tanggal">

                            {% with data_hari=jadwal_lama|dict_get:user.nik|dict_get:tgl %}

                            <select class="form-control form-control-sm mb-1"
                                    name="shift_{{ user.nik }}_{{ tgl }}_1">

                                <option value="-" disabled {% if not data_hari %}selected{% endif %}>
                                    -
                                </option>

                                {% for schedule in schedules %}

                                    {% with selected_value=data_hari|dict_get:1 %}

                                        {% if selected_value == "CUTI" %}
                                            {% if schedule.id == "CUTI" %}
                                                <option value="CUTI" selected>CUTI</option>
                                            {% endif %}

                                        {% else %}
                                            {% if schedule.id != "CUTI" %}
                                                <option value="{{ schedule.id }}"
                                                    {% if selected_value == schedule.id %}selected{% endif %}
                                                >
                                                    {{ schedule.name }}
                                                </option>
                                            {% endif %}
                                        {% endif %}

                                    {% endwith %}

                                {% endfor %}
                            </select>

                            <select class="form-control form-control-sm"
                                    name="shift_{{ user.nik }}_{{ tgl }}_2">

                                <option value="-" {% if not data_hari %}selected{% endif %}>
                                    -
                                </option>

                                {% for schedule in schedules %}

                                    {% with selected_value=data_hari|dict_get:2 %}

                                        {% if selected_value == "CUTI" %}
                                            {% if schedule.id == "CUTI" %}
                                                <option value="CUTI" selected>CUTI</option>
                                            {% endif %}

                                        {% else %}
                                            {% if schedule.id != "CUTI" %}
                                                <option value="{{ schedule.id }}"
                                                    {% if selected_value == schedule.id %}selected{% endif %}
                                                >
                                                    {{ schedule.name }}
                                                </option>
                                            {% endif %}
                                        {% endif %}

                                    {% endwith %}

                                {% endfor %}
                            </select>

                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-footer text-right">
            <button type="submit" class="btn btn-success">
                <i class="fa fa-save"></i> Simpan Perubahan
            </button>
        </div>
    </form>
</div>

{% endblock %}