{% extends 'layouts/layout.html' %}
{% load static %}
{% block content %}

<div class="modal-content mb-5">

  <div class="modal-header bg-primary">
    <h4 class="modal-title text-white">Edit Pengajuan Izin</h4>
    <a href="{% url 'pengajuan_izin' %}" class="close">
      <span>&times;</span>
    </a>
  </div>

  <form method="POST"
        action="{% url 'edit_pengajuan_izin' pengajuan.id %}"
        enctype="multipart/form-data">
    {% csrf_token %}

    <input type="hidden" name="nik_id" value="{{ user.nik }}">

    <div class="modal-body">

      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label>Jenis Izin</label>
            <select class="form-control" name="izin" id="izin" required>
              <option value="" disabled>-- Pilih Izin --</option>
              {% for izin in izin_list %}
                <option
                  value="{{ izin.id }}"
                  data-max-days="{{ izin.max_days }}"
                  data-is-requires-attachment="{{ izin.is_requires_attachment }}"
                  {% if izin.id == pengajuan.permission_type_id %} selected {% endif %}
                >
                  {{ izin.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <label>Pilih Atasan</label>
            <select class="form-control" name="boss" required>
              <option value="" disabled>-- Pilih Atasan --</option>
              {% for boss in boss_list %}
                <option value="{{ boss.nik }}"
                  {% if pengajuan.user_target and boss.nik == pengajuan.user_target.nik %}
                    selected
                  {% endif %}
                >
                  {{ boss.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label>Tanggal Mulai</label>
            <input type="date"
                   class="form-control"
                   id="start_date"
                   name="start_date"
                   value="{{ pengajuan.start_date|date:'Y-m-d' }}"
                   required>
          </div>
        </div>

        <div class="col-md-6" id="endDateWrapper">
          <div class="form-group">
            <label>Tanggal Selesai</label>
            <input type="date"
                   class="form-control"
                   id="end_date"
                   name="end_date"
                   value="{{ pengajuan.end_date|date:'Y-m-d' }}">
          </div>
        </div>
      </div>

      <div class="form-group">
        <small class="text-danger" id="autoInfo" style="display:none;">
          Tanggal selesai ditentukan otomatis oleh sistem:
          <strong><span id="endDate"></span></strong>
        </small>
      </div>

      <div class="form-group" id="attachmentWrapper" style="display:none;">
        <label>
          Foto Pendukung
          <span class="text-danger" style="font-size:12px;">(Required)</span>
        </label>
        <input type="file"
               class="form-control mb-2"
               id="photo"
               name="photo"
               accept="image/*">

        {% if pengajuan.photo %}
          <img src="{{ pengajuan.photo.url }}" style="width:150px;">
        {% else %}
          <span class="text-muted">Tidak ada lampiran</span>
        {% endif %}
      </div>

      <div class="form-group">
        <label>Alasan</label>
        <textarea class="form-control"
                  name="reason"
                  rows="3">{{ pengajuan.reason }}</textarea>
      </div>

    </div>

    <div class="modal-footer justify-content-between">
      <a href="{% url 'pengajuan_izin' %}" class="btn btn-danger">
        <i class="fa fa-times"></i> Batal
      </a>
      <button type="submit" class="btn btn-primary">
        Simpan Perubahan
      </button>
    </div>

  </form>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.getElementById('end_date').addEventListener('blur', function() {
    const mulai = new Date(document.getElementById('start_date').value) || 0;
    const selesai = new Date(this.value);
    const sekarang = new Date();

    const opsi = { month: 'long', day: '2-digit', year: 'numeric' };
  
    const formatMulai = mulai.toLocaleDateString('en-US', opsi).replace(',', '');
    const formatSelesai = selesai.toLocaleDateString('en-US', opsi).replace(',', '');

    if (selesai < mulai) {
        Swal.fire({
            icon: 'error',
            title: 'Tanggal tidak valid',
            text: 'Tanggal selesai tidak boleh lebih awal daripada tanggal mulai!',
        });
        this.value = "";
    }

    if (sekarang > mulai || sekarang > selesai){
        Swal.fire({
            icon: 'warning',
            title: 'Tanggalnya bener ga ?',
            text: `${formatMulai} s.d. ${formatSelesai}!`,
            icon: 'warning',
            showCancelButton: true,
            cancelButtonColor: '#E0A800',
            confirmButtonColor: '#28A745',
            cancelButtonText: 'Ganti Tanggal',
            confirmButtonText: 'Betull',
        }).then((result) => {
            if (result.isConfirmed) {

            } else {
              this.value = "";
              document.getElementById('start_date').value = "";
            }
        });
    }
});
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {

    function updateFormByPermission() {
        let startDateVal = $('#start_date').val();
        let selected = $('#izin option:selected');

        let maxDays = selected.data('max-days');
        let isRequiresAttachment = selected.data('is-requires-attachment');

        maxDays = (maxDays === undefined || maxDays === null)
                    ? 0
                    : parseInt(maxDays);

        if (maxDays > 0) {
            $('#endDateWrapper').hide();
            $('#end_date').prop('required', false);

            if (startDateVal) {
                let startDate = new Date(startDateVal);
                startDate.setDate(startDate.getDate() + maxDays - 1);

                let yyyy = startDate.getFullYear();
                let mm = String(startDate.getMonth() + 1).padStart(2, '0');
                let dd = String(startDate.getDate()).padStart(2, '0');

                $('#end_date').val(`${yyyy}-${mm}-${dd}`);
                $('#endDate').text(`${dd}-${mm}-${yyyy}`);
            }

            $('#autoInfo').show();
        } else {
            $('#endDateWrapper').show();
            $('#end_date').prop('required', true);
            $('#autoInfo').hide();
        }

        if (isRequiresAttachment === true || isRequiresAttachment === 'True') {
            $('#attachmentWrapper').show();
            $('#photo').prop('required', true);
        } else {
            $('#attachmentWrapper').hide();
            $('#photo').prop('required', false);
        }
    }

    $('#izin').on('change', updateFormByPermission);
    $('#start_date').on('change', updateFormByPermission);

    updateFormByPermission();
});
</script>

{% endblock %}
